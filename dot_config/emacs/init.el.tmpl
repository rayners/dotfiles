;; -*- lexical-binding: t; -*-

;; Font configuration using fontaine
;; Values are populated from centralized font settings in chezmoi

;; Initialize package system
(require 'package)
(add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t)
(package-initialize)

;; Install use-package if not present
(unless (package-installed-p 'use-package)
  (package-refresh-contents)
  (package-install 'use-package))

(require 'use-package)
(setq use-package-always-ensure t) ;; Always ensure packages are installed

;; Fontaine for font management
(use-package fontaine
  :ensure t
  :config
  ;; Define font presets from centralized font configuration
  (setq fontaine-presets
        '((default
           :default-family "{{ .fonts.monospace }}"
           :default-height {{ .fonts.emacs.default_height }}
           :variable-pitch-family "{{ .fonts.emacs.variable_pitch }}"
           :fixed-pitch-family "{{ .fonts.emacs.fixed_pitch }}"
           {{- if .fonts.monospace_ligatures }}
           :ligatures t
           {{- end }})
          
          (presentation
           :default-family "{{ .fonts.monospace }}"
           :default-height {{ mul .fonts.emacs.default_height 1.5 }}
           :variable-pitch-family "{{ .fonts.emacs.variable_pitch }}"
           :fixed-pitch-family "{{ .fonts.emacs.fixed_pitch }}")
          
          (reading
           :default-family "{{ .fonts.emacs.variable_pitch }}"
           :default-height {{ .fonts.emacs.default_height }}
           :variable-pitch-family "{{ .fonts.emacs.variable_pitch }}"
           :fixed-pitch-family "{{ .fonts.emacs.fixed_pitch }}")))
  
  ;; Apply default preset on startup and after changing fonts
  (fontaine-set-preset 'default)
  (add-hook 'after-setting-font-hook #'fontaine-apply-current-preset))

;; Set up ligatures if enabled
{{- if .fonts.monospace_ligatures }}
(use-package ligature
  :ensure t
  :config
  ;; Enable common ligature sets
  (ligature-set-ligatures 't '("www" "**" "***" "**/" "*>" "*/" "\\\\" "\\\\\\"
                               "{-" "[::" ":::" ":=" "!!" "!=" "!==" "-}"
                               "--" "---" "-->" "->" "->>" "-<" "-<<" "-~"
                               "#{" "#[" "##" "###" "####" "#(" "#?" "#_" "#_("
                               ".-" ".=" ".." "..<" "..." "?=" "??" ";;" "/*"
                               "/**" "/=" "/==" "/>" "//" "///" "&&" "||" "||="
                               "|=" "|>" "^=" "$>" "++" "+++" "+>" "=:=" "=="
                               "===" "==>" "=>" "=>>" "<=" "=<<" "=/=" ">-" ">="
                               ">=>" ">>" ">>-" ">>=" ">>>" "<*" "<*>" "<|" "<|>"
                               "<$" "<$>" "<!--" "<-" "<--" "<->" "<+" "<+>" "<="
                               "<==" "<=>" "<=<" "<>" "<<" "<<-" "<<=" "<<<" "<~"
                               "<~~" "</" "</>" "~@" "~-" "~=" "~>" "~~" "~~>" "%%"))
  ;; Enable ligatures globally
  (global-ligature-mode t))
{{- end }}

;; Example of a keybinding to switch font presets
(global-set-key (kbd "C-c f d") (lambda () (interactive) (fontaine-set-preset 'default)))
(global-set-key (kbd "C-c f p") (lambda () (interactive) (fontaine-set-preset 'presentation)))
(global-set-key (kbd "C-c f r") (lambda () (interactive) (fontaine-set-preset 'reading)))

;; Load font presets from custom file if it exists
(let ((custom-fontaine-file (expand-file-name "fontaine-custom.el" user-emacs-directory)))
  (when (file-exists-p custom-fontaine-file)
    (load-file custom-fontaine-file)))

;; This is just a starter configuration focused on font management
;; Customize this file with your preferred Emacs settings